<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha do Militar - P1</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; margin: 0; padding-top: 90px; }
        
        .toolbar { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 2000; }
        .toolbar-group { display: flex; gap: 10px; }

        .ficha-container { max-width: 1000px; margin: 0 auto 40px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); overflow: hidden; }
        .ficha-header { background: #1a5c37; color: white; padding: 25px; display: flex; align-items: center; gap: 20px; }
        .foto-perfil { width: 140px; height: 180px; border: 3px solid white; object-fit: cover; border-radius: 5px; cursor: pointer; }
        
        .secao-titulo { background: #f0f0f0; padding: 10px 20px; font-weight: bold; color: #1a5c37; border-left: 5px solid #1a5c37; margin-top: 10px; }
        .dados-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; } /* 3 Colunas */
        
        .item-dado { border-bottom: 1px solid #eee; padding: 5px 0; }
        .label { font-weight: bold; color: #666; font-size: 0.7rem; text-transform: uppercase; }
        .valor-input { border: 1px solid transparent; background: transparent; font-size: 0.95rem; color: #000; width: 100%; outline: none; padding: 4px 0; }
        
        .modo-edicao .valor-input { border-bottom: 1px solid #f0ad4e; background: #fffdf2; }

        .btn { border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-voltar { background: #333; color: white; }
        .btn-edit { background: #f0ad4e; color: white; }
        .btn-save { background: #28a745; color: white; display: none; }
        .btn-print { background: #1a5c37; color: white; width: auto; } /* Largura contida */

        @media print { .toolbar { display: none; } body { padding-top: 0; } .ficha-container { box-shadow: none; border: 1px solid #ccc; } }
        @media (max-width: 768px) { .dados-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-group">
            <a href="index.html" class="btn btn-voltar">‚¨Ö Voltar</a>
            <button id="btnEditar" class="btn btn-edit" onclick="ativarEdicao()">‚úèÔ∏è Editar</button>
            <button id="btnSalvar" class="btn btn-save" onclick="salvarFicha()">üíæ Salvar</button>
        </div>
        <button class="btn btn-print" onclick="window.print()">üñ® Imprimir Ficha</button>
    </div>

    <div id="conteudo-ficha" class="ficha-container">
        <div style="padding: 50px; text-align: center;">Carregando...</div>
    </div>

    <script src="../js/config.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const matricula = sessionStorage.getItem("matricula_selecionada");
            const dadosSalvos = sessionStorage.getItem("lista_efetivo");

            if (!matricula || !dadosSalvos) { window.location.href = "index.html"; return; }

            const militar = JSON.parse(dadosSalvos).find(m => String(m["MATR√çCULA"]) === String(matricula));
            if (!militar) { document.getElementById('conteudo-ficha').innerHTML = "Militar n√£o encontrado."; return; }

            renderizar(militar);
        });

        function renderizar(mil) {
            const container = document.getElementById('conteudo-ficha');
            const get = (campo) => mil[campo] || "---";

            container.innerHTML = `
                <div class="ficha-header">
                    <img id="imgPerfil" src="${get("FOTO")}" class="foto-perfil" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1053/1053244.png'" onclick="alterarFoto()">
                    <div>
                        <h1 style="margin:0">${get("GRADUA√á√ÉO")} ${get("NOME GUERRA")}</h1>
                        <p style="margin:5px 0; opacity: 0.9;">Matr√≠cula: ${get("MATR√çCULA")}</p>
                    </div>
                </div>
                <div class="secao-titulo">DADOS CADASTRAIS</div>
                <div class="dados-grid">
                    ${campoHTML("Nome Completo", get("NOME COMPLETO"))}
                    ${campoHTML("CPF", get("CPF"))}
                    ${campoHTML("RG", get("RG"))}
                    ${campoHTML("Nascimento", get("NASCIMENTO"))}
                    ${campoHTML("Situa√ß√£o", get("SITUA√á√ÉO"))}
                    ${campoHTML("Fun√ß√£o", get("FUN√á√ÉO"))}
                    ${campoHTML("Local", get("LOCAL"))}
                    ${campoHTML("Telefone", get("TELEFONE"))}
                    ${campoHTML("E-mail", get("EMAIL"))}
                </div>
                <div class="secao-titulo">OBSERVA√á√ïES</div>
                <div style="padding: 20px;">
                    <textarea class="valor-input" id="obs" style="width:100%; min-height:80px;" readonly>${get("OBSERVA√á√ÉO")}</textarea>
                </div>
            `;
        }

        function campoHTML(label, valor) {
            return `<div class="item-dado"><span class="label">${label}</span><input type="text" class="valor-input" value="${valor}" readonly data-label="${label}"></div>`;
        }

        function ativarEdicao() {
            document.querySelectorAll('.valor-input').forEach(i => i.readOnly = false);
            document.getElementById('conteudo-ficha').classList.add('modo-edicao');
            document.getElementById('btnEditar').style.display = 'none';
            document.getElementById('btnSalvar').style.display = 'inline-flex';
        }

        function alterarFoto() {
            if(!document.getElementById('conteudo-ficha').classList.contains('modo-edicao')) return;
            const link = prompt("URL da nova foto:");
            if(link) document.getElementById('imgPerfil').src = link;
        }

        async function salvarFicha() {
    const btn = document.getElementById('btnSalvar');
    btn.disabled = true;
    btn.innerText = "‚åõ Salvando...";

    const matricula = sessionStorage.getItem("matricula_selecionada");
    const inputs = document.querySelectorAll('.valor-input[data-label]');
    const dadosEditados = {};

    // Coleta os dados dos inputs
    inputs.forEach(input => {
        dadosEditados[input.getAttribute('data-label')] = input.value;
    });

    // Pega o link da foto atual da imagem no HTML
    dadosEditados["FOTO"] = document.getElementById('imgPerfil').src;

    try {
        const response = await fetch(CONFIG.URL_GAS, {
            method: 'POST',
            body: JSON.stringify({
                action: "updateMilitar",
                matricula: matricula,
                dados: dadosEditados
            })
        });

        const res = await response.json();
        
        if (res.success) {
            // --- ATUALIZA√á√ÉO DO CACHE LOCAL ---
            let lista = JSON.parse(sessionStorage.getItem("lista_efetivo"));
            const index = lista.findIndex(m => String(m["MATR√çCULA"]) === String(matricula));
            
            if (index !== -1) {
                // Atualiza o objeto na lista local com os novos dados
                lista[index] = { ...lista[index], ...dadosEditados };
                sessionStorage.setItem("lista_efetivo", JSON.stringify(lista));
            }

            alert("Sucesso! Os dados foram salvos na planilha.");
            window.location.reload(); 
        } else {
            alert("Erro: " + res.message);
        }
    } catch (error) {
        console.error(error);
        alert("Erro ao conectar com o servidor.");
    } finally {
        btn.disabled = false;
        btn.innerText = "üíæ Salvar";
    }
}
    </script>
</body>
</html>
